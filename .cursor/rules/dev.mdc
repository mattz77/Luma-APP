---
alwaysApply: true
---

# Regras para Desenvolvimento Luma (Expo + Supabase + n8n)

VocÃª Ã© um Arquiteto de Software SÃªnior e Engenheiro Fullstack especializado no ecossistema Luma. Seu objetivo Ã© desenvolver um aplicativo domÃ©stico resiliente, seguro e focado em IA.

## ğŸŒ Idioma e ComunicaÃ§Ã£o

### âš ï¸ REGRA CRÃTICA: Commits em PortuguÃªs

**TODOS os commits DEVE ser escritos em PORTUGUÃŠS BRASILEIRO**, incluindo:
- Mensagens de commit geradas automaticamente
- Mensagens de commit manuais
- DescriÃ§Ãµes de commit
- Mensagens de "generate commit message" do Cursor

**Formato de Commit (Conventional Commits em PortuguÃªs):**
```
<tipo>: <descriÃ§Ã£o curta em portuguÃªs>

<corpo opcional em portuguÃªs explicando o que e por quÃª>

<rodapÃ© opcional>
```

**Tipos de commit em portuguÃªs:**
- `feat:` - Nova funcionalidade
- `fix:` - CorreÃ§Ã£o de bug
- `docs:` - DocumentaÃ§Ã£o
- `style:` - FormataÃ§Ã£o, ponto e vÃ­rgula, etc (nÃ£o afeta cÃ³digo)
- `refactor:` - RefatoraÃ§Ã£o de cÃ³digo
- `perf:` - Melhoria de performance
- `test:` - AdiÃ§Ã£o ou correÃ§Ã£o de testes
- `chore:` - MudanÃ§as em build, dependÃªncias, ferramentas
- `ci:` - MudanÃ§as em CI/CD
- `build:` - MudanÃ§as no sistema de build

**Exemplos:**
```
feat: adiciona integraÃ§Ã£o com n8n para chat Luma
fix: corrige erro de autenticaÃ§Ã£o no login
docs: atualiza README com instruÃ§Ãµes de instalaÃ§Ã£o
chore: migra projeto para Bun runtime
refactor: melhora estrutura de hooks do React Query
```

**IMPORTANTE**: Quando usar a funcionalidade "generate commit message" do Cursor ou qualquer geraÃ§Ã£o automÃ¡tica de mensagens de commit, SEMPRE gere em portuguÃªs brasileiro.

### âš ï¸ REGRA CRÃTICA: Encoding e Caracteres Especiais

**TODOS os commits DEVEM usar encoding UTF-8** para garantir que caracteres especiais do portuguÃªs sejam exibidos corretamente:

- âœ… **CORRETO**: Use acentos e caracteres especiais normalmente (Ã¡, Ã©, Ã­, Ã³, Ãº, Ã£, Ãµ, Ã§, etc.)
- âŒ **ERRADO**: Evite substituir caracteres especiais por versÃµes sem acento
- âœ… **GARANTIR**: Certifique-se de que o terminal/editor estÃ¡ configurado para UTF-8
- âœ… **VERIFICAR**: Sempre verifique o commit apÃ³s criar para garantir que caracteres especiais estÃ£o corretos

**Exemplos de commits com caracteres especiais:**
```
âœ… feat: adiciona configuraÃ§Ã£o de notificaÃ§Ãµes
âœ… fix: corrige erro de autenticaÃ§Ã£o
âœ… docs: atualiza documentaÃ§Ã£o de instalaÃ§Ã£o
âœ… refactor: melhora estrutura de componentes
```

**Problemas comuns a evitar:**
- âŒ "obrigatÃƒÂ³ria" (encoding incorreto)
- âŒ "portuguÃƒÂªs" (encoding incorreto)
- âŒ "obrigatoria" (sem acento - evite quando possÃ­vel)
- âœ… "obrigatÃ³ria" (UTF-8 correto)
- âœ… "portuguÃªs" (UTF-8 correto)

## Stack TecnolÃ³gico (ReferÃªncia Estrita)

- **Frontend Mobile**: Expo SDK 54, Expo Router v6, React Native 0.81, TypeScript, Reanimated v4
- **Backend/DB**: Supabase (Auth, Postgres + PostGIS, Storage, Realtime), Edge Functions
- **ORM/Data**: Prisma ORM (Schema Reference)
- **AI & OrquestraÃ§Ã£o**: n8n (Webhooks, AI Agents), OpenAI/Anthropic via n8n
- **Arquitetura**: Mobile-First, Multi-tenant (Isolamento por house_id)

### âš ï¸ REGRA CRÃTICA: Consulta ObrigatÃ³ria aos Guias MPC

**SEMPRE** que for alterar, criar ou ajustar qualquer coisa relacionada a:
- Expo SDK 54
- Expo Router v6
- React Native 0.81
- TypeScript
- Reanimated v4
- Qualquer mÃ³dulo ou funcionalidade do Expo

**DEVE** consultar primeiro os guias em `docs/mpc-guides/`:
- `Expo SDK 54 + Router v6 + React Native 0.81 + TypeScript + Reanimated v4.md` - Manual completo do stack
- `expo_doc_guide.md` - Guia de documentaÃ§Ã£o do Expo
- `como criar efeito liquid glass do ios 26 com expo.md` - Guia de efeitos visuais

### âš ï¸ Guias de SeguranÃ§a ObrigatÃ³rios:
- `security/rls-testing-checklist.md` - Como validar isolamento multi-tenant
- `security/n8n-webhook-auth.md` - PadrÃµes de autenticaÃ§Ã£o HMAC
- `security/expo-integrity-setup.md` - ConfiguraÃ§Ã£o de App Attest

**Processo obrigatÃ³rio:**
1. Antes de implementar, ler o guia relevante em `docs/mpc-guides/`
2. Seguir os padrÃµes, APIs e melhores prÃ¡ticas documentados
3. Verificar compatibilidade com SDK 54 e Router v6
4. Usar as APIs e hooks recomendados pelos guias
5. Aplicar as configuraÃ§Ãµes sugeridas (babel, app.json, etc.)

**Exemplos de quando consultar:**
- Criar nova rota â†’ Consultar guia de Expo Router v6
- Adicionar animaÃ§Ã£o â†’ Consultar guia de Reanimated v4
- Configurar mÃ³dulo Expo â†’ Consultar expo_doc_guide.md
- Implementar efeito visual â†’ Consultar guia de liquid glass ou similar
- Resolver problema de build â†’ Consultar guia do SDK 54
- Adicionar dependÃªncia â†’ Verificar compatibilidade com SDK 54 nos guias
- Configurar navegaÃ§Ã£o â†’ Consultar padrÃµes do Router v6 nos guias

## PrincÃ­pios Fundamentais

### 1. Isolamento Multi-Tenant (Regra de Ouro)

âš ï¸ **CRÃTICO**: Toda operaÃ§Ã£o de banco de dados, lÃ³gica de negÃ³cio ou consulta de IA DEVE ser escopada pelo `house_id`.

- Nunca consulte dados do usuÃ¡rio sem filtrar pela casa ativa
- **RLS (Row Level Security)**: Sempre assuma que o RLS estÃ¡ ativo no Supabase. Suas queries devem respeitar as polÃ­ticas de `auth.uid()` e associaÃ§Ã£o em `house_members`

**Checklist de ValidaÃ§Ã£o RLS (ObrigatÃ³rio):**

Antes de finalizar qualquer feature que acessa dados:

1. **Teste Cross-Tenant**: Tente acessar dados de outra casa com credentials vÃ¡lidas â†’ Deve retornar vazio
2. **Teste sem Session**: Remova auth.uid() do contexto â†’ Deve falhar
3. **SQL Injection Test**: Use `'; DROP TABLE expenses; --` como house_id â†’ Deve sanitizar
4. **Verify Policy Exists**: Execute `SELECT * FROM pg_policies WHERE tablename = 'expenses';` para confirmar polÃ­ticas ativas

### 2. Performance Mobile-First

- Use **Reanimated v4** para todas as interaÃ§Ãµes gestuais e animaÃ§Ãµes. Evite Animated API do React Native legado
- **Worklets ObrigatÃ³rios**: SEMPRE use a diretiva `'worklet'` em `useAnimatedStyle` para garantir execuÃ§Ã£o na UI thread (60fps)

```typescript
// âŒ EVITE: Roda na JS thread
const animatedStyle = useAnimatedStyle(() => {
  return { opacity: fadeAnim.value };
});

// âœ… USE: Roda na UI thread (60fps garantido)
const animatedStyle = useAnimatedStyle(() => {
  'worklet'; // Diretiva obrigatÃ³ria
  return { opacity: withSpring(fadeAnim.value) };
});
```

- Use **FlashList** (Shopify) ao invÃ©s de FlatList para listas longas (Despesas, Tarefas)
- Priorize componentes nativos via Expo SDK
- **Cache Strategy**: Use SWR ou React Query com stale-while-revalidate para reduzir chamadas ao Supabase

```typescript
// Exemplo de cache com SWR
import useSWR from 'swr';

const { data: expenses } = useSWR(
  ['expenses', houseId],
  () => fetchExpenses(houseId),
  { revalidateOnFocus: false, dedupingInterval: 30000 } // Cache 30s
);
```

### 3. Tipagem Estrita (TypeScript)

- NÃ£o use `any`
- Utilize os tipos gerados pelo Prisma (`User`, `House`, `Expense`, etc.) para interfaces de frontend
- Defina interfaces explÃ­citas para payloads de Webhook (App â†” n8n)

## Diretrizes de Desenvolvimento por Camada

### A. Frontend (Expo & React Native)

- **Roteamento**: Use Expo Router v6 (baseado em arquivos). Estruture pastas como `app/(tabs)/finance/index.tsx`
- **EstilizaÃ§Ã£o**: Use uma abordagem consistente (NativeWind ou StyleSheet otimizado). Mantenha o Design System (fontes Inter, Phosphor Icons)
- **Gerenciamento de Estado**: Prefira estados locais simples ou Stores leves (Zustand/Jotai) para dados globais (SessÃ£o do UsuÃ¡rio, Casa Atual)
- **Feedback**: Sempre implemente loading states e optimistic updates para aÃ§Ãµes como "Concluir Tarefa" ou "Adicionar Despesa"

### B. Backend & Dados (Supabase & Prisma)

- **Schema Awareness**: Consulte sempre o arquivo `luma_prisma_schema.txt` antes de gerar queries
- **Ãndices Compostos ObrigatÃ³rios**: Para queries frequentes multi-tenant, SEMPRE adicione Ã­ndices compostos no Prisma Schema:

```prisma
model Expense {
  // ... campos existentes
  @@index([house_id, expense_date(sort: Desc)]) // Ãndice composto
  @@index([house_id, created_by])
}
```

- **ValidaÃ§Ã£o de Schema**: Execute `npx prisma generate` antes de commits e adicione `npm run type-check` ao CI/CD
- **Edge Functions**: Use Edge Functions apenas para lÃ³gicas que nÃ£o podem ser resolvidas via SQL ou n8n (ex: manipulaÃ§Ã£o complexa de imagens)
- **Realtime**: Implemente `supabase.channel` para atualizaÃ§Ãµes instantÃ¢neas no Chat da Luma e Status de Tarefas

### C. IntegraÃ§Ã£o de IA (n8n)

**Protocolo de ComunicaÃ§Ã£o:**

- O App **nunca** fala diretamente com a LLM
- O App envia POST para Webhook do n8n

**AutenticaÃ§Ã£o ObrigatÃ³ria (HMAC + JWT):**

âš ï¸ **CRÃTICO**: Webhooks n8n DEVEM usar autenticaÃ§Ã£o HMAC e JWT para proteger dados sensÃ­veis.

```typescript
// PadrÃ£o obrigatÃ³rio para chamadas n8n
const n8nWebhookCall = async (payload: LumaWebhookPayload) => {
  // Gerar JWT com claims criptografadas (nÃ£o enviar user_id/house_id em texto plano)
  const token = jwt.sign(
    { user_id: payload.user_id, house_id: payload.house_id, exp: Date.now() + 3600000 },
    process.env.JWT_SECRET!
  );
  
  // Assinatura HMAC para validaÃ§Ã£o
  const signature = crypto
    .createHmac('sha256', process.env.N8N_WEBHOOK_SECRET!)
    .update(JSON.stringify({ token, message: payload.message }))
    .digest('hex');
  
  const response = await fetch(N8N_WEBHOOK_URL, {
    headers: {
      'X-Luma-Signature': signature,
      'Authorization': `Bearer ${process.env.N8N_API_KEY}`,
    },
    body: JSON.stringify({ token, message: payload.message, context: payload.context }),
  });
};
```

**Payload PadrÃ£o (Seguro):**

```json
{
  "token": "eyJhbGc...", // JWT contendo user_id, house_id, exp
  "message": "string",
  "context": {
    "current_route": "finance",
    "role": "admin"
  }
}
```

**Rate Limiting ObrigatÃ³rio:**

Implemente throttle no frontend para prevenir spam:

```typescript
import { useThrottle } from '@react-hook/throttle';

const [sendMessage, setSendMessage] = useThrottle('', 2000); // Max 1 req/2s
```

**UX de Chat**: O frontend deve tratar a resposta do n8n como streaming ou resposta Ãºnica, exibindo metadados (ex: "Processando gastos...") se fornecidos.

## Regras de ValidaÃ§Ã£o de CÃ³digo

Antes de finalizar qualquer cÃ³digo, verifique:

1. **house_id**: A query SQL ou chamada de API inclui o filtro da casa?
2. **Tratamento de Erro EspecÃ­fico**: Use padrÃ£o obrigatÃ³rio para chamadas n8n com retry logic e UX clara:

```typescript
// Pattern obrigatÃ³rio para chamadas n8n
try {
  const response = await fetchWithTimeout(N8N_WEBHOOK_URL, payload, 10000);
} catch (error) {
  if (error.name === 'AbortError') {
    // Timeout: mostrar "A Luma estÃ¡ pensando... tente novamente"
    showRetryableError();
  } else if (error.status === 429) {
    // Rate limit: "Muitas mensagens. Aguarde 30s"
    showRateLimitError();
  } else {
    // Erro desconhecido: log para Sentry + fallback
    Sentry.captureException(error);
    showGenericError();
  }
}
```

3. **Tipos**: As props dos componentes batem com o Schema do Prisma? Execute `npx prisma generate` e `npm run type-check`
4. **DependÃªncias**: Estou usando uma lib compatÃ­vel com Expo SDK 54? (Evite libs que exigem eject)
5. **Ãndices**: Queries com filtros por house_id tÃªm Ã­ndices compostos no Prisma Schema?
6. **Worklets**: AnimaÃ§Ãµes Reanimated v4 usam a diretiva `'worklet'`?
7. **AutenticaÃ§Ã£o**: Webhooks n8n tÃªm HMAC signature e JWT no payload?

## Comandos EspecÃ­ficos para o Cursor

- **"Criar uma nova feature"**: Analise o PRD, verifique quais tabelas do Prisma sÃ£o afetadas, defina a rota no Expo Router e, se necessÃ¡rio, o payload do webhook para o n8n
- **"Ajustar o Chat Luma"**: Foque na interface de chat (UI) e na estrutura do JSON enviado para o n8n. NÃ£o tente recriar a lÃ³gica da LLM no frontend
- **"Otimizar"**: Procure por re-renders desnecessÃ¡rios e sugira `useMemo`/`useCallback` ou conversÃ£o para FlashList

## Formato de Resposta Esperado

Ao gerar cÃ³digo, use a seguinte estrutura:

1. **AnÃ¡lise RÃ¡pida**: "Baseado no schema HouseMember e requisitos de Finance..."
2. **Plano de AlteraÃ§Ã£o**: Arquivos a serem tocados
3. **CÃ³digo**: Blocos de cÃ³digo TypeScript completos e tipados
4. **Check de SeguranÃ§a**: "Nota: Esta query garante isolamento via house_id."

## SeguranÃ§a de App (SDK 54+)

âš ï¸ **ObrigatÃ³rio para Features CrÃ­ticas:**

- Configure `expo-app-integrity` para validar requests crÃ­ticos (pagamentos, webhooks)
- No backend, valide tokens do Google Play Integrity / App Attest antes de processar
- Endpoint exemplo: POST /api/verify-device
- Previne chamadas de apps modificados/clonados

## Roadmap Awareness

Esteja ciente que estamos na **Fase 1 (MVP)**.

- **Foque em**: CRUD FinanÃ§as, Tarefas, Chat BÃ¡sico
- **Deixe preparado (stubs)**: IoT Devices, AutomaÃ§Ãµes complexas

## âœ… Checklist de Pull Request (ObrigatÃ³rio)

Antes de mergear qualquer cÃ³digo, verifique:

- [ ] RLS testado com credenciais de outra casa (teste cross-tenant)
- [ ] Webhook n8n tem autenticaÃ§Ã£o HMAC/JWT implementada
- [ ] Queries tÃªm Ã­ndices compostos por house_id no Prisma Schema
- [ ] AnimaÃ§Ãµes usam worklets do Reanimated v4 (diretiva `'worklet'`)
- [ ] Erros de rede tÃªm retry logic e UX clara (timeout, rate limit, genÃ©rico)
- [ ] Cache implementado para queries frequentes (SWR/React Query)
- [ ] Tipos TypeScript gerados do Prisma estÃ£o atualizados (`npx prisma generate`)
- [ ] Rate limiting aplicado em endpoints sensÃ­veis (throttle no frontend)
- [ ] Expo App Integrity configurado para features crÃ­ticas (se aplicÃ¡vel)
- [ ] Testes de SQL Injection realizados (sanitizaÃ§Ã£o de inputs)

## Exemplo de ImplementaÃ§Ã£o Segura (Pattern)

### âŒ RUIM (Inseguro/Lento):

```typescript
// Fetching all expenses locally and filtering
const { data } = await supabase.from('expenses').select('*');
const myExpenses = data.filter(e => e.house_id === currentHouse.id);
```

### âœ… BOM (Seguro/PerformÃ¡tico):

```typescript
// Filtering at DB level with strict typing
const { data: expenses, error } = await supabase
  .from('expenses')
  .select(`
    *,
    category:expense_categories(name, icon, color),
    created_by:users(name, avatar_url)
  `)
  .eq('house_id', houseId) // CRÃTICO
  .order('expense_date', { ascending: false })
  .limit(20);
```

{
  "id": "7QiKCoD8cBXVAoHq",
  "name": "Luma - AI Assistant with Action Tools",
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "errorWorkflow": "",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "tags": [
    {
      "id": "ekW0aAEml2BqOvOl",
      "name": "Main Agent",
      "createdAt": "2025-11-26T04:37:32.164Z",
      "updatedAt": "2025-11-26T04:37:32.164Z"
    }
  ],
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "luma-chat-enhanced",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "When Chat Message Received",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [768, 400],
      "webhookId": "luma-chat-enhanced",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ded8131b-817e-4f9b-9272-ddfc0025f476",
              "name": "=house_id",
              "value": "={{ $json.house_id }}",
              "type": "string"
            },
            {
              "id": "c81b9bbb-db0d-4fd3-ba6d-6563a968343f",
              "name": "=user_id",
              "value": "={{ $json.user_id }}",
              "type": "string"
            },
            {
              "id": "0fb5e382-c89e-4cfa-a32e-a6b9d00e99f4",
              "name": "=message",
              "value": "={{ $json.message }}",
              "type": "string"
            },
            {
              "id": "e6d865a7-3270-4f82-97c4-dc2a426d5dea",
              "name": "=context_mode",
              "value": "={{ $json.context?.mode || 'chat' }}",
              "type": "string"
            },
            {
              "id": "5c370c6b-7de3-4f0a-b8f9-455e6bc3a11c",
              "name": "=session_id",
              "value": "={{ $json.session_id }}",
              "type": "string"
            },
            {
              "id": "fd332862-a564-4403-af2d-c915aaf762d5",
              "name": "=chatInput",
              "value": "={{ $json.message }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "extract-context",
      "name": "Extract Context",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1024, 400]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "house_id",
              "name": "house_id",
              "value": "={{ $('Extract Context').item.json.house_id }}",
              "type": "string"
            },
            {
              "id": "user_id",
              "name": "user_id",
              "value": "={{ $('Extract Context').item.json.user_id }}",
              "type": "string"
            },
            {
              "id": "message",
              "name": "message",
              "value": "={{ $('Extract Context').item.json.message }}",
              "type": "string"
            },
            {
              "id": "session_id",
              "name": "session_id",
              "value": "={{ $('Extract Context').item.json.session_id }}",
              "type": "string"
            },
            {
              "id": "sessionId",
              "name": "sessionId",
              "value": "={{ $('Extract Context').item.json.session_id }}",
              "type": "string"
            },
            {
              "id": "chatInput",
              "name": "chatInput",
              "value": "={{ $('Extract Context').item.json.chatInput }}",
              "type": "string"
            }
          ]
        }
      },
      "id": "preserve-context",
      "name": "Preserve Context",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1024, 560]
    },
    {
      "parameters": {
        "url": "={{ $env.SUPABASE_URL }}/functions/v1/hybrid-search",
        "method": "POST",
        "sendHeaders": true,
        "sendBody": true,
        "jsonParameters": true,
        "headerParametersJson": "={\"Authorization\": \"Bearer {{$env.SUPABASE_SERVICE_ROLE_KEY}}\", \"Content-Type\": \"application/json\"}",
        "bodyParametersJson": "={\"query\": $json.chatInput || $json.message, \"house_id\": $json.house_id, \"match_count\": 5, \"doc_type\": \"manual\"}",
        "responseFormat": "json",
        "options": {
          "timeout": 10000
        }
      },
      "id": "rag-hybrid-search",
      "name": "RAG Hybrid Search",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [1216, 688],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "language": "javaScript",
        "mode": "runOnceForAllItems",
        "jsCode": "const httpData = $input.first().json || {};\nconst body = httpData.body || httpData || {};\nconst results = Array.isArray(body.results) ? body.results : [];\nconst context = $('Preserve Context').item?.json || {};\nconst topResults = results.slice(0, 5).map((doc, idx) => ({\n  index: idx + 1,\n  id: doc.id,\n  doc_type: doc.doc_type,\n  snippet: (doc.content || '').slice(0, 320).trim(),\n  metadata: doc.metadata || {},\n  score: doc.combined_score ?? doc.semantic_similarity ?? doc.keyword_rank ?? null,\n}));\nconst ragContext = topResults\n  .map(r => `[${r.index}] (${r.doc_type || 'doc'}) ${r.snippet}`)\n  .join('\\n');\nreturn {\n  json: {\n    ...context,\n    rag_results: topResults,\n    rag_context: ragContext || 'sem snippets RAG nesta consulta',\n    rag_debug: {\n      match_count: topResults.length,\n      raw_results_count: results.length,\n    },\n  },\n};"
      },
      "id": "build-rag-context",
      "name": "Build RAG Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1440, 688],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "=Voc√™ √© Luma üè†, uma assistente de IA inteligente e amig√°vel para gest√£o dom√©stica.\n\n**CONTEXTO DA CASA:**\n- House ID: {{ $json.house_id }}\n- User ID: {{ $json.user_id }}\n\n**CONTEXTO RAG (docs internos):**\n{{ $json.rag_context || 'sem snippets RAG nesta consulta' }}\n\n**SUAS CAPACIDADES:**\n\n1. üí∞ **Finan√ßas:** Consultar despesas, or√ßamento, criar novos registros\n2. üìã **Tarefas:** Listar tarefas, criar novas, atribuir respons√°veis\n3. üë• **Membros:** Ver quem mora na casa, pap√©is e status\n\n**FERRAMENTAS DISPON√çVEIS:**\n- `get_financial_summary`: Resumo financeiro completo\n- `get_tasks`: Listar tarefas ativas\n- `create_task`: Criar nova tarefa (use com informa√ß√µes dispon√≠veis, defaults s√£o aplicados automaticamente)\n- `create_expense`: Registrar despesa (use com informa√ß√µes dispon√≠veis, defaults s√£o aplicados automaticamente)\n- `get_house_members`: Informa√ß√µes dos membros\n\n**REGRA DE OURO - CRIAR TAREFAS E DESPESAS:**\n\n‚ö†Ô∏è **NUNCA pergunte informa√ß√µes antes de criar!** Crie IMEDIATAMENTE com as informa√ß√µes dispon√≠veis e use defaults para campos opcionais:\n\n**Para Tarefas:**\n- ‚úÖ Extraia o T√çTULO da mensagem do usu√°rio (sempre poss√≠vel)\n- ‚úÖ Se mencionar data/hor√°rio, extraia. Se n√£o, deixe NULL (campo opcional)\n- ‚úÖ Se mencionar prioridade, infira. Se n√£o, use MEDIUM (default)\n- ‚úÖ Se mencionar pessoa, identifique. Se n√£o, use created_by_id (default)\n- ‚úÖ Crie a tarefa IMEDIATAMENTE ap√≥s identificar o t√≠tulo\n- ‚úÖ Confirme a cria√ß√£o e apenas DEPOIS pergunte se quer ajustar algo\n\n**Para Despesas:**\n- ‚úÖ Extraia VALOR da mensagem (sempre poss√≠vel de identificar)\n- ‚úÖ Identifique CATEGORIA mencionada. Se n√£o mencionar, use \"Outros\"\n- ‚úÖ Se mencionar data, extraia. Se n√£o, use hoje (default)\n- ‚úÖ Crie a despesa IMEDIATAMENTE ap√≥s identificar valor e categoria\n- ‚úÖ Confirme a cria√ß√£o e apenas DEPOIS pergunte se quer ajustar algo\n\n**COMO RESPONDER:**\n\n1. **Seja Natural e Amig√°vel:**\n   - Use emojis relevantes (mas n√£o exagere)\n   - Trate o usu√°rio de forma calorosa\n   - Use linguagem brasileira informal mas respeitosa\n\n2. **Seja PROATIVA - Crie IMEDIATAMENTE:**\n   - Quando usu√°rio pedir para criar tarefa/despesa, CRIE na mesma resposta\n   - N√£o pergunte antes, CRIE primeiro, depois confirme\n   - Use informa√ß√µes dispon√≠veis e defaults para o resto\n\n3. **Seja Precisa:**\n   - Use as ferramentas para buscar dados reais\n   - Formate valores monet√°rios: R$ 1.234,56\n   - Formate datas de forma leg√≠vel: \"15 de novembro\"\n\n4. **Seja √ötil:**\n   - Crie tarefas/despesas IMEDIATAMENTE quando solicitado\n   - Confirme a√ß√µes realizadas de forma clara\n   - S√≥ pergunte detalhes DEPOIS de criar, se quiser sugerir melhorias\n\n**EXEMPLOS:**\n\nüë§ \"Caminhar no parque\"\nüí° Crie IMEDIATAMENTE: Use `create_task` com title=\"Caminhar no parque\", due_date=null (sem data), priority=MEDIUM (default), assigned_to_id=created_by_id (default)\n‚úÖ Resposta: \"Perfeito! ‚úÖ Criei a tarefa 'Caminhar no parque'. Quer adicionar data espec√≠fica ou atribuir a algu√©m?\"\n\nüë§ \"Gastei R$ 45,50 no supermercado\"\nüí° Crie IMEDIATAMENTE: Use `create_expense` com amount=45.50, category=\"Alimenta√ß√£o\", description=\"Supermercado\", expense_date=hoje (default)\n‚úÖ Resposta: \"Registrado! üí∞ Criei a despesa de R$ 45,50 na categoria Alimenta√ß√£o (Supermercado). Quer ajustar algo?\"\n\nüë§ \"Crie uma tarefa para comprar leite amanh√£\"\nüí° Crie IMEDIATAMENTE: Use `create_task` com title=\"Comprar leite\", due_date=amanh√£, priority=MEDIUM (default)\n‚úÖ Resposta: \"Pronto! ‚úÖ Criei a tarefa 'Comprar leite' para amanh√£. Quer atribuir a algu√©m espec√≠fico?\"\n\nüë§ \"Como est√£o as finan√ßas?\"\nüí° Use `get_financial_summary` ‚Üí \"Ol√°! üí∞ Este m√™s voc√™s gastaram R$ 3.450 de um or√ßamento de R$ 4.000 (86%). As maiores despesas foram: Aluguel (R$ 1.500), Supermercado (R$ 980) e Energia (R$ 340). Ainda restam R$ 550 para os pr√≥ximos 10 dias. Quer ver mais detalhes?\"\n\n**REGRAS CR√çTICAS:**\n- ‚ö†Ô∏è **NUNCA pergunte antes de criar tarefa/despesa**\n- ‚úÖ **SEMPRE crie IMEDIATAMENTE** com informa√ß√µes dispon√≠veis\n- ‚úÖ Use defaults para campos opcionais (MEDIUM priority, created_by_id, hoje, etc.)\n- ‚úÖ Confirme cria√ß√£o e apenas DEPOIS sugira ajustes opcionais\n- ‚úÖ Sempre use as ferramentas para buscar dados atualizados\n- ‚úÖ Nunca invente n√∫meros ou datas\n- ‚úÖ Mantenha respostas concisas mas completas"
        }
      },
      "id": "ai-agent",
      "name": "Luma AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [1328, 192],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "success-check",
              "leftValue": "={{ $('Luma AI Agent').item?.json?.output ? 'success' : 'error' }}",
              "rightValue": "success",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-success",
      "name": "Check Success or Error",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [1632, 192],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "success",
              "name": "success",
              "value": "true",
              "type": "boolean"
            },
            {
              "id": "response",
              "name": "response",
              "value": "={{ $('Luma AI Agent').item.json.output }}",
              "type": "string"
            },
            {
              "id": "metadata",
              "name": "metadata",
              "value": "={{ { session_id: $('Extract Context').item.json.session_id, processing_time_ms: $now.diff($('When Chat Message Received').item.json.timestamp || $now, 'milliseconds'), tools_used: $('Luma AI Agent').item.json.usedTools || [], model: 'gemini-1.5-pro' } }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "id": "format-success-response",
      "name": "Format Success Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1904, -16]
    },
    {
      "parameters": {
        "jsCode": "const inputData = $input.first();\nconst contextMode = $('Extract Context').item.json.context_mode || 'chat';\nconst agentOutput = $('Luma AI Agent').item.json;\n\n// Se n√£o for modo magic_create, apenas passa os dados adiante\nif (contextMode !== 'magic_create') {\n  return inputData.json;\n}\n\n// Extrai dados das tools usadas pelo Agent\nconst usedTools = agentOutput.usedTools || [];\nconst message = $('Extract Context').item.json.message || '';\nconst lowerMessage = message.toLowerCase();\n\n// Detecta se h√° m√∫ltiplas entidades (despesa + tarefa)\nconst hasExpense = lowerMessage.includes('r$') || lowerMessage.includes('comprar') || lowerMessage.includes('gast') || usedTools.includes('Create Expense Tool');\nconst hasTask = lowerMessage.includes('fazer') || lowerMessage.includes('limpar') || lowerMessage.includes('tarefa') || lowerMessage.includes('preciso') || usedTools.includes('Create Task Tool');\n\nconst results = [];\n\n// Se detectou despesa\nif (hasExpense) {\n  const amountMatch = message.match(/R\$?\s*([0-9]+(?:[.,][0-9]+)?)/i);\n  const amount = amountMatch ? parseFloat(amountMatch[1].replace(',', '.')) : 0;\n  \n  // Extrai descri√ß√£o da despesa\n  let description = message;\n  if (hasTask) {\n    // Tenta separar despesa de tarefa (antes de \"e fazer\", \"e limpar\", etc)\n    const taskMatch = message.match(/\s+e\s+(fazer|limpar|tarefa|preciso)/i);\n    if (taskMatch && taskMatch.index !== undefined) {\n      description = message.substring(0, taskMatch.index).trim();\n    }\n  }\n  \n  description = description.replace(/R\$?\s*[0-9]+(?:[.,][0-9]+)?/gi, '').trim();\n  \n  // Extrai data\n  let expenseDate = new Date().toISOString().split('T')[0];\n  if (lowerMessage.includes('amanh√£') || lowerMessage.includes('amanha')) {\n    const tomorrow = new Date();\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    expenseDate = tomorrow.toISOString().split('T')[0];\n  }\n  \n  results.push({\n    type: 'expense',\n    data: {\n      title: description || message,\n      amount: amount.toFixed(2),\n      date: lowerMessage.includes('amanh√£') || lowerMessage.includes('amanha') ? 'Amanh√£' : 'Hoje',\n      description: description || message\n    }\n  });\n}\n\n// Se detectou tarefa\nif (hasTask) {\n  // Extrai descri√ß√£o da tarefa\n  let taskDescription = message;\n  if (hasExpense) {\n    // Tenta pegar parte ap√≥s despesa (depois de \"e fazer\", \"e limpar\", etc)\n    const taskMatch = message.match(/\s+e\s+(fazer|limpar|tarefa|preciso)\s+(.+)/i);\n    if (taskMatch && taskMatch[2]) {\n      taskDescription = taskMatch[2].trim();\n    } else {\n      // Se n√£o encontrou padr√£o, tenta pegar parte ap√≥s o valor\n      const expenseMatch = message.match(/R\$?\s*[0-9]+(?:[.,][0-9]+)?/i);\n      if (expenseMatch && expenseMatch.index !== undefined) {\n        const afterExpense = message.substring(expenseMatch.index + expenseMatch[0].length).replace(/^\s+e\s+/i, '').trim();\n        if (afterExpense) {\n          taskDescription = afterExpense;\n        }\n      }\n    }\n  }\n  \n  // Extrai t√≠tulo (primeira parte, removendo palavras temporais)\n  let title = taskDescription\n    .replace(/\b(amanh√£|hoje|depois|√†s|as|e)\b/gi, '')\n    .trim()\n    .split(/[.!?]/)[0];\n  \n  // Extrai data/hora\n  let dueDate = null;\n  if (lowerMessage.includes('amanh√£') || lowerMessage.includes('amanha')) {\n    const hourMatch = message.match(/(\d{1,2})[hH]/);\n    if (hourMatch) {\n      const tomorrow = new Date();\n      tomorrow.setDate(tomorrow.getDate() + 1);\n      const hour = parseInt(hourMatch[1]);\n      dueDate = `${tomorrow.toISOString().split('T')[0]}T${hour.toString().padStart(2, '0')}:00:00Z`;\n    } else {\n      dueDate = 'Amanh√£';\n    }\n  } else if (lowerMessage.includes('hoje')) {\n    dueDate = 'Hoje';\n  }\n  \n  results.push({\n    type: 'task',\n    data: {\n      title: title || taskDescription || message,\n      due_date: dueDate\n    }\n  });\n}\n\n// Se n√£o encontrou nenhum, tenta inferir do tipo da mensagem\nif (results.length === 0) {\n  if (lowerMessage.includes('r$') || lowerMessage.includes('comprar') || lowerMessage.includes('gast')) {\n    // √â provavelmente uma despesa\n    const amountMatch = message.match(/R\$?\s*([0-9]+(?:[.,][0-9]+)?)/i);\n    const amount = amountMatch ? parseFloat(amountMatch[1].replace(',', '.')) : 0;\n    const description = message.replace(/R\$?\s*[0-9]+(?:[.,][0-9]+)?/gi, '').trim();\n    \n    results.push({\n      type: 'expense',\n      data: {\n        title: description || message,\n        amount: amount.toFixed(2),\n        date: lowerMessage.includes('hoje') ? 'Hoje' : (lowerMessage.includes('amanh√£') || lowerMessage.includes('amanha') ? 'Amanh√£' : 'Hoje'),\n        description: description || message\n      }\n    });\n  } else {\n    // √â provavelmente uma tarefa\n    results.push({\n      type: 'task',\n      data: {\n        title: message,\n        due_date: lowerMessage.includes('hoje') ? 'Hoje' : (lowerMessage.includes('amanh√£') || lowerMessage.includes('amanha') ? 'Amanh√£' : null)\n      }\n    });\n  }\n}\n\n// Retorna array se m√∫ltiplas entidades, objeto √∫nico se apenas uma\nconst parsedData = results.length > 1 ? results : results[0];\n\nreturn {\n  json: {\n    success: inputData.json.success,\n    response: inputData.json.response,\n    metadata: {\n      ...inputData.json.metadata,\n      parsed: parsedData\n    }\n  }\n};"
      },
      "id": "extract-magic-data",
      "name": "Extract Magic Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1904, 160]
    },
    {
      "parameters": {
        "jsCode": "const inputData = $input.first();\nconst rawResponse = inputData.json.response || '';\n\n// Remove todos os marcadores <function=...>...</function>\nlet cleanedResponse = rawResponse.replace(/<function[^>]*>.*?<\\/function>/gis, '');\n\n// Remove blocos JSON isolados que possam ter sobrado\ncleanedResponse = cleanedResponse.replace(/\\{[^}]*\"input\"[^}]*\\}/gi, '');\n\n// Remove m√∫ltiplos espa√ßos em branco e quebras de linha extras\ncleanedResponse = cleanedResponse.replace(/\\s+/g, ' ').trim();\n\n// Remove espa√ßos antes de pontua√ß√£o\ncleanedResponse = cleanedResponse.replace(/\\s+([.,!?])/g, '$1');\n\n// Se a resposta ficou vazia ap√≥s limpeza, usa a original\nif (!cleanedResponse || cleanedResponse.length < 10) {\n  cleanedResponse = rawResponse;\n}\n\nconst result = {\n  json: {\n    success: inputData.json.success,\n    response: cleanedResponse,\n    metadata: inputData.json.metadata\n  }\n};\n\nreturn result;"
      },
      "id": "clean-response",
      "name": "Clean Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2208, -16],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "house_id",
              "name": "house_id",
              "value": "={{ $('Extract Context').item.json.house_id }}",
              "type": "string"
            },
            {
              "id": "user_id",
              "name": "user_id",
              "value": "={{ $('Extract Context').item.json.user_id }}",
              "type": "string"
            },
            {
              "id": "message",
              "name": "message",
              "value": "={{ $('Extract Context').item.json.message }}",
              "type": "string"
            },
            {
              "id": "response",
              "name": "response",
              "value": "={{ $('Clean Response').item.json.response }}",
              "type": "string"
            },
            {
              "id": "metadata",
              "name": "metadata",
              "value": "={{ $('Clean Response').item.json.metadata }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "id": "prepare-supabase-data",
      "name": "Prepare Data for Supabase",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [2624, -224]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "success",
              "name": "success",
              "value": "false",
              "type": "boolean"
            },
            {
              "id": "error",
              "name": "error",
              "value": "Erro ao processar mensagem. Por favor, verifique sua configura√ß√£o da API.",
              "type": "string"
            },
            {
              "id": "response",
              "name": "response",
              "value": "Desculpe, n√£o consegui processar sua mensagem no momento. Por favor, tente novamente mais tarde.",
              "type": "string"
            },
            {
              "id": "metadata",
              "name": "metadata",
              "value": "={{ { session_id: $json.session_id, error_type: 'api_error' } }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "id": "format-error-response",
      "name": "Format Error Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [1872, 432]
    },
    {
      "parameters": {
        "tableId": "conversations",
        "dataToSend": "autoMapInputData",
        "inputsToIgnore": "success,error"
      },
      "id": "save-conversation",
      "name": "Save Conversation",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [2880, -224],
      "credentials": {
        "supabaseApi": {
          "id": "uL2vmdiTTuvYEYED",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond-to-webhook",
      "name": "Send Response to App",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [3184, -16]
    },
    {
      "parameters": {
        "workflowId": "cGyItSRsdZNgckJD",
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "house_id": "={{ $json.house_id }}"
          }
        }
      },
      "id": "financial-tool",
      "name": "Financial Summary Tool",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [1808, 992]
    },
    {
      "parameters": {
        "workflowId": "L64eapJkSiGVqk8M",
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "house_id": "={{ $json.house_id }}"
          }
        }
      },
      "id": "tasks-tool",
      "name": "Tasks Tool",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [1952, 992]
    },
    {
      "parameters": {
        "workflowId": "BNClJiGssddwxd4l",
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        }
      },
      "id": "create-task-tool",
      "name": "Create Task Tool",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [2096, 1008]
    },
    {
      "parameters": {
        "workflowId": "0PIUT3hZLLDhxmmJ",
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {}
        }
      },
      "id": "create-expense-tool",
      "name": "Create Expense Tool",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [2256, 1008]
    },
    {
      "parameters": {
        "workflowId": "YwDx7YchL6xmZYhg",
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "house_id": "={{ $json.house_id }}"
          }
        }
      },
      "id": "members-tool",
      "name": "House Members Tool",
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [2400, 1024]
    },
    {
      "parameters": {},
      "id": "memory-postgres-new",
      "name": "Postgres Chat Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [1424, 912],
      "credentials": {
        "postgres": {
          "id": "BE85CrHQoBaxbvPn",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "model": "llama3.1:8b-instruct-q4_K_M",
        "options": {
          "temperature": 0.7,
          "topP": 0.9,
          "keepAlive": "5m",
          "lowVram": true,
          "numCtx": 4096
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [1312, 480],
      "id": "42e62d02-a08d-4d2e-b565-c97d1247dd9e",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "czClAwaWeb0F3nko",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "content": "## ü§ñ Luma AI Assistant - Enhanced with Action Tools\n\n**Fluxo Principal:**\n1. Recebe mensagem via webhook POST /luma/chat\n2. Extrai contexto (house_id, user_id, message)\n3. AI Agent processa com Google Gemini Pro + Memory\n4. Agent pode usar ferramentas:\n   - üí∞ Financial Summary (consulta despesas e or√ßamento)\n   - üìã Get Tasks (lista tarefas)\n   - ‚úÖ Create Task (cria nova tarefa)\n   - üíµ Create Expense (registra despesa)\n   - üë• Get House Members (info membros)\n5. Salva conversa no Supabase\n6. Retorna resposta JSON para o app\n\n**Diferenciais:**\n‚ú® Agent decide automaticamente quais ferramentas usar\n‚ú® Pode executar a√ß√µes (criar tarefas/despesas)\n‚ú® Mem√≥ria de conversa√ß√£o persistente\n‚ú® Respostas contextualizadas e inteligentes\n\n**Modelo:** Google Gemini 1.5 Pro"
      },
      "id": "sticky-note",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-144, 112]
    }
  ],
  "connections": {
    "When Chat Message Received": {
      "main": [
        [
          {
            "node": "Extract Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Context": {
      "main": [
        [
          {
            "node": "Preserve Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preserve Context": {
      "main": [
        [
          {
            "node": "RAG Hybrid Search",
            "type": "main",
            "index": 0
          },
          {
            "node": "Postgres Chat Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RAG Hybrid Search": {
      "main": [
        [
          {
            "node": "Build RAG Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build RAG Context": {
      "main": [
        [
          {
            "node": "Luma AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Luma AI Agent": {
      "main": [
        [
          {
            "node": "Check Success or Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Success or Error": {
      "main": [
        [
          {
            "node": "Format Success Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Error Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Success Response": {
      "main": [
        [
          {
            "node": "Extract Magic Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Magic Data": {
      "main": [
        [
          {
            "node": "Clean Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Clean Response": {
      "main": [
        [
          {
            "node": "Prepare Data for Supabase",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Response to App",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Data for Supabase": {
      "main": [
        [
          {
            "node": "Save Conversation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Error Response": {
      "main": [
        [
          {
            "node": "Send Response to App",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "main": [
        []
      ],
      "ai_memory": [
        [
          {
            "node": "Luma AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Luma AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Financial Summary Tool": {
      "ai_tool": [
        [
          {
            "node": "Luma AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Tasks Tool": {
      "ai_tool": [
        [
          {
            "node": "Luma AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create Task Tool": {
      "ai_tool": [
        [
          {
            "node": "Luma AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create Expense Tool": {
      "ai_tool": [
        [
          {
            "node": "Luma AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "House Members Tool": {
      "ai_tool": [
        [
          {
            "node": "Luma AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  }
}
